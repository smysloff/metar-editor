import AMTK_ICAOS from"./icaos.mjs";import AMTK_VISIBILITY from"./visibility.mjs";import AMTK_Form from"./form_manager.mjs";const form=new AMTK_Form("#amtk_metar_editor");function updateType(){let e="";for(const t of this.elements.type)if(t.checked){e+=t.value;break}const{cor:t}=this.elements;return e+=t.checked?` ${t.value}`:"",e}function updateAssumptions(){const{icao:e,icao_variants:t}=this.elements,{value:a}=e;t.innerHTML="";for(const e of AMTK_ICAOS)if(e.startsWith(a)){const a=document.createElement("option");a.value=e,a.textContent=e,t.append(a)}}function updateICAO(){const{icao:e}=this.elements,{value:t}=e;return 4===t.length?t:""}function datetime_update(e){const{date:t,time:a}=this.elements,l=t.value?.split("-")?.at(-1),u=a.value?.split(":")?.join("");return l&&u?`${l}${u}Z`:""}function setCurrentDatetime(){const{date:e,time:t}=this.elements,a=new Date,l=a.getUTCFullYear(),u=(a.getUTCMonth()+1).toString().padStart(2,"0"),d=a.getUTCDate().toString().padStart(2,"0"),i=a.getUTCHours().toString().padStart(2,"0"),r=a.getUTCMinutes().toString().padStart(2,"0");e.value=`${l}-${u}-${d}`,t.value=`${i}:${r}`}function updateWind(){const{units:e}=this.elements,{direction:t,speed:a,gust:l}=this.elements,{direction_range:u,speed_range:d,gust_range:i}=this.elements,{vrb:r}=this.elements;let s="";if(""===t.value||""===a.value)return s;s+=`${t.value.padStart(3,"0")}${a.value.padStart(2,"0")}`,+l.value>+a.value&&(s+="G"+ +l.value);for(const t of e)if(t.checked){s+=`${t.value}`;break}return s}function auxiliaryWind(e,t){const{direction:a,speed:l,gust:u}=this.elements,{direction_range:d,speed_range:i,gust_range:r}=this.elements;switch(t){case a:d.value=""===e?-10:10*Math.round(.1*e);break;case l:i.value=""===e?-1:e;break;case u:r.value=""===e?-1:e}}function auxiliaryWindRange(e,t){const{direction:a,speed:l,gust:u}=this.elements,{direction_range:d,speed_range:i,gust_range:r}=this.elements;switch(t){case d:a.value="-10"===e?"":parseInt(e);break;case i:l.value="-1"===e?"":parseInt(e);break;case r:u.value="-1"===e?"":parseInt(e)}}function updateVisibility(){const{visibility:e}=this.elements,{value:t}=e;return""===t?"":t.padStart(4,"0")}function auxiliaryPhenomena(e){const{weather:t}=this.elements;""!==e&&(t.value+=e)}function updateWeather(){const{weather:e}=this.elements,t=e.value.trim();return t.length>1?t:""}function formatClouds(e){if(""===(e=e.trim()))return"";const t=e.substr(0,3).replace(/\D/,"");return+t>120?120:t}function updateClouds(e,t){let a,l,u;const{clouds_1:d,clouds_1_coverage:i,clouds_1_height:r,clouds_1_type:s}=this.elements,{clouds_2:n,clouds_2_coverage:o,clouds_2_height:c,clouds_2_type:m}=this.elements,{clouds_3:p,clouds_3_coverage:h,clouds_3_height:_,clouds_3_type:f}=this.elements,{clouds_4:y,clouds_4_coverage:v,clouds_4_height:g,clouds_4_type:x}=this.elements;if(d===t||i===t||r===t||Array.from(s).includes(t))a=d.value.trim(),l=i.value,u=s;else if(n===t||o===t||c===t||Array.from(m).includes(t))a=n.value.trim(),l=o.value,u=m;else if(p===t||h===t||_===t||Array.from(f).includes(t))a=p.value.trim(),l=h.value,u=f;else{if(y!==t&&v!==t&&g!==t&&!Array.from(x).includes(t))throw new TypeError("Unable to find the required cloud layer");a=y.value.trim(),l=v.value,u=x}if(""===a)return"";let b="";b+=l,b+=a.padStart(3,"0");for(const e of u)e.checked&&(b+=e.value);return b}function auxiliaryClouds1(e){const{clouds_1_height:t}=this.elements;t.value=""===e?-1:+e}function auxiliaryClouds1Height(e){const{clouds_1:t}=this.elements;t.value=-1===+e?"":e}function auxiliaryClouds1Coverage(e){const{clouds_1:t,clouds_1_height:a,clouds_1_type:l}=this.elements;"NCD"===e&&(t.value="",a.value=-1,l.forEach((e=>e.checked=!1)))}function auxiliaryClouds1Type(e,t){const{clouds_1_type:a}=this.elements;for(const e of a)e!==t&&(e.checked=!1)}function updateClouds2(){let{clouds_2:e,clouds_2_coverage:t,clouds_2_type:a}=this.elements;if(e=e.value.trim(),t=t.value,""===e||"NCD"===t)return"";let l="";l+=t,l+=e.padStart(3,"0");for(const e of a)e.checked&&(l+=e.value);return l}function auxiliaryClouds2(e){const{clouds_2_height:t}=this.elements;t.value=""===e?-1:+e}function auxiliaryClouds2Height(e){const{clouds_2:t}=this.elements;t.value=-1===+e?"":e}function auxiliaryClouds2Coverage(e){const{clouds_2:t,clouds_2_height:a,clouds_2_type:l}=this.elements;"NCD"===e&&(t.value="",a.value=-1,l.forEach((e=>e.checked=!1)))}function auxiliaryClouds2Type(e,t){const{clouds_2_type:a}=this.elements;for(const e of a)e!==t&&(e.checked=!1)}function updateClouds3(){let{clouds_3:e,clouds_3_coverage:t,clouds_3_type:a}=this.elements;if(e=e.value.trim(),t=t.value,""===e||"NCD"===t)return"";let l="";l+=t,l+=e.padStart(3,"0");for(const e of a)e.checked&&(l+=e.value);return l}function auxiliaryClouds3(e){const{clouds_3_height:t}=this.elements;t.value=""===e?-1:+e}function auxiliaryClouds3Height(e){const{clouds_3:t}=this.elements;t.value=-1===+e?"":e}function auxiliaryClouds3Coverage(e){const{clouds_3:t,clouds_3_height:a,clouds_3_type:l}=this.elements;"NCD"===e&&(t.value="",a.value=-1,l.forEach((e=>e.checked=!1)))}function auxiliaryClouds3Type(e,t){const{clouds_3_type:a}=this.elements;for(const e of a)e!==t&&(e.checked=!1)}function auxiliaryClouds4(e){const{clouds_4_height:t}=this.elements;t.value=""===e?-1:+e}function auxiliaryClouds4Height(e){const{clouds_4:t}=this.elements;t.value=-1===+e?"":e}function auxiliaryClouds4Coverage(e){const{clouds_4:t,clouds_4_height:a,clouds_4_type:l}=this.elements;"NCD"===e&&(t.value="",a.value=-1,l.forEach((e=>e.checked=!1)))}function auxiliaryClouds4Type(e,t){const{clouds_4_type:a}=this.elements;for(const e of a)e!==t&&(e.checked=!1)}function formatTemperature(e){if("-"===(e=e.trim()))return e;if(""===e||isNaN(e))return"";const t=+e.match(/-?\d?\d?/);return isNaN(t)&&e.startsWith("-")?"-":isNaN(t)?"":t<-80?-80:t>80?80:t}function updateTemperature(){const{temperature:e,dew_point:t}=this.elements;if(["","-"].includes(e.value)&&["","-"].includes(t.value))return"";const a=isNaN(+e.value)?"":e.value,l=isNaN(+t.value)?"":t.value;let u="";return u+=""===a?"/":a.replace("-","M"),u+="/",u+=""===l?"/":l.replace("-","M"),u}function auxiliaryTemperature(e,t){const{temperature:a,dew_point:l}=this.elements,{temperature_range:u,dew_point_range:d}=this.elements,{temperature_minus:i,dew_point_minus:r}=this.elements;let s=null,n=null;switch(t){case a:s=u,n=i;break;case l:s=d,n=r;break;default:throw new TypeError("unknown element")}if(!(s instanceof HTMLInputElement))throw new TypeError("not an input element");if(!(n instanceof HTMLInputElement))throw new TypeError("minusElement is not a proper HTMLInputElement");s.value=""===e||"-"===e?-1:Math.abs(e),n.checked=e.startsWith("-")}function auxiliaryTemperatureRange(e,t){const{temperature:a,dew_point:l}=this.elements,{temperature_range:u,dew_point_range:d}=this.elements,{temperature_minus:i,dew_point_minus:r}=this.elements;let s="",n="";switch(t){case u:s=a,n=i;break;case d:s=l,n=r;break;default:throw new Error("unknown element")}if(!(s instanceof HTMLInputElement&&"value"in s))throw new TypeError("linkedElement must be a typeof HTMLInputElement(text), but got "+typeof s);if(!(n instanceof HTMLInputElement)||"checkbox"!==n?.type)throw new TypeError("minusElement must be a typeof HTMLInputElement(checkbox), but got "+typeof n);s.value=e<0?"":n.checked?`-${e}`:e}function auxiliaryTemperatureMinus(e,t){const{temperature:a,dew_point:l}=this.elements;let u="",d="";switch(t.checked&&(d+="-"),t.name){case"temperature_minus":u=a;break;case"dew_point_minus":u=l;break;default:throw TypeError("unknown element name")}d+=u.value.replace(/\D/,""),isNaN(d)||(u.value=d)}function auxiliaryPressure(e,t){const{pressure:a,pressure_range:l}=this.elements;switch(t){case a:l.value=a.value;break;case l:a.value=l.value}}function updatePressure(e,t){const a=e<900||e>1100?"":e;return""===a?"":`Q${a}`}form.addHandler("type",{checked:"METAR",update:updateType}),form.addHandler("type",{element:"cor",update:updateType}),form.addHandler("icao",{format:e=>e.trim().toUpperCase().replace(/[^A-Z]/,"").substring(0,4),auxiliary:updateAssumptions,update:updateICAO}),form.addHandler("icao",{element:"icao_variants",init:updateAssumptions,auxiliary(e,t){const{icao:a}=this.elements;a.value=e},update:updateICAO}),form.addHandler("datetime",{element:"date",update:datetime_update}),form.addHandler("datetime",{element:"time",update:datetime_update}),form.addHandler("datetime",{element:"current",auxiliary:setCurrentDatetime,update:datetime_update}),form.addHandler("wind",{element:"calm",auxiliary(e,t){const{units:a}=this.elements,{direction:l,speed:u,gust:d}=this.elements,{direction_range:i,speed_range:r,gust_range:s}=this.elements;a.forEach((e=>e.disabled=t.checked)),l.disabled=t.checked,u.disabled=t.checked,d.disabled=t.checked,i.disabled=t.checked,r.disabled=t.checked,s.disabled=t.checked,t.checked&&(a.forEach((e=>e.checked="MPS"===e.value)),l.value="",u.value="",d.value="",i.value=-10,r.value=-1,s.value=-1)},update:(e,t)=>t.checked?"CALM":""}),form.addHandler("wind",{element:"units",init(e){for(const t of e)t.checked="MPS"===t.value},update:updateWind}),form.addHandler("wind",{element:"direction",format(e){const t=parseInt(e.trim().replace(/\D/,"").substring(0,3));return isNaN(t)?"":t>360?360:t},auxiliary(e){const{direction_range:t}=this.elements;t.value=""===e?-20:e},update:updateWind}),form.addHandler("wind",{element:"speed",format:e=>parseInt(e.trim().replace(/\D/,"").substring(0,2)),auxiliary(e){const{speed_range:t}=this.elements;t.value=e},update:updateWind}),form.addHandler("wind",{element:"gust",format:e=>parseInt(e.trim().replace(/\D/,"").substring(0,2)),auxiliary(e){const{gust_range:t}=this.elements;t.value=e},update:updateWind}),form.addHandler("wind",{element:"direction_range",auxiliary:auxiliaryWindRange,update:updateWind}),form.addHandler("wind",{element:"speed_range",auxiliary:auxiliaryWindRange,update:updateWind}),form.addHandler("wind",{element:"gust_range",auxiliary:auxiliaryWindRange,update:updateWind}),form.addHandler("cavok",{element:"cavok",auxiliary(e,t){const{result:a}=this,{visibility:l,visibility_range:u}=this.elements,{weather:d,intensity:i,precipitation:r,phenomena:s}=this.elements,{clouds_1_coverage:n,clouds_1:o,clouds_1_type:c,clouds_1_height:m}=this.elements,{clouds_2_coverage:p,clouds_2:h,clouds_2_type:_,clouds_2_height:f}=this.elements,{clouds_3_coverage:y,clouds_3:v,clouds_3_type:g,clouds_3_height:x}=this.elements,{clouds_4_coverage:b,clouds_4:C,clouds_4_type:T,clouds_4_height:H}=this.elements;t.checked?(l.value="",u.value=-1,d.value="",i.forEach((e=>e.checked=!1)),r.value="",s.value="",n.value="NCD",o.value="",c.forEach((e=>e.checked=!1)),m.value=-1,p.value="NCD",h.value="",_.forEach((e=>e.checked=!1)),f.value=-1,y.value="NCD",v.value="",g.forEach((e=>e.checked=!1)),x.value=-1,b.value="NCD",C.value="",T.forEach((e=>e.checked=!1)),H.value=-1,l.disabled=!0,u.disabled=!0,d.disabled=!0,i.forEach((e=>e.disabled=!0)),r.disabled=!0,s.disabled=!0,n.disabled=!0,o.disabled=!0,c.forEach((e=>e.disabled=!0)),m.disabled=!0,p.disabled=!0,h.disabled=!0,_.forEach((e=>e.disabled=!0)),f.disabled=!0,y.disabled=!0,v.disabled=!0,g.forEach((e=>e.disabled=!0)),x.disabled=!0,b.disabled=!0,C.disabled=!0,T.forEach((e=>e.disabled=!0)),H.disabled=!0,a.set("visibility",""),a.set("weather",""),a.set("clouds_1",""),a.set("clouds_2",""),a.set("clouds_3",""),a.set("clouds_4","")):(l.disabled=!1,u.disabled=!1,d.disabled=!1,i.forEach((e=>e.disabled=!1)),r.disabled=!1,s.disabled=!1,n.disabled=!1,o.disabled=!1,c.forEach((e=>e.disabled=!1)),m.disabled=!1,p.disabled=!1,h.disabled=!1,_.forEach((e=>e.disabled=!1)),f.disabled=!1,y.disabled=!1,v.disabled=!1,g.forEach((e=>e.disabled=!1)),x.disabled=!1,b.disabled=!1,C.disabled=!1,T.forEach((e=>e.disabled=!1)),H.disabled=!1)},update:(e,t)=>t.checked?t.value:""}),form.addHandler("visibility",{format:e=>e.trim().replace(/\D/,"").substring(0,4),auxiliary(e){const{visibility_range:t}=this.elements;""===e&&(t.value=-1);const a=+e,l=a<800?50:a<5e3?100:a<9999?1e3:0;let u=AMTK_VISIBILITY.at(-1);if(l>0){const e=Math.floor(a/l)*l;u=AMTK_VISIBILITY.indexOf(e)}t.value=u.toString()},update:updateVisibility}),form.addHandler("visibility",{element:"visibility_range",init(e){const t=e[0];t.setAttribute("min",0),t.setAttribute("max",AMTK_VISIBILITY.length-1),t.value=AMTK_VISIBILITY[0]},auxiliary(e){e=+e;const{visibility:t}=this.elements;t.value=0===e?"":AMTK_VISIBILITY[e]},update:updateVisibility}),form.addHandler("weather",{element:"weather",format:e=>e.toUpperCase().replace(/[^-+A-Z ]/,""),auxiliary(e){const{intensity:t}=this.elements,a=e[0];for(const e of t)e.checked=e.value===a},update:updateWeather}),form.addHandler("weather",{element:"intensity",auxiliary(e,t){let a="";const{intensity:l,weather:u}=this.elements;for(const e of l)e!==t&&(e.checked=!1),e.checked&&(a=e.value);u.value=u.value.replace(/^[+-]/,""),a&&(u.value=a+u.value)},update:updateWeather}),form.addHandler("weather",{element:"precipitation",auxiliary:auxiliaryPhenomena,update:updateWeather}),form.addHandler("weather",{element:"phenomena",auxiliary:auxiliaryPhenomena,update:updateWeather}),form.addHandler("clouds_1",{element:"clouds_1",format:formatClouds,auxiliary:auxiliaryClouds1,update:updateClouds}),form.addHandler("clouds_1",{element:"clouds_1_height",auxiliary:auxiliaryClouds1Height,update:updateClouds}),form.addHandler("clouds_1",{element:"clouds_1_coverage",auxiliary:auxiliaryClouds1Coverage,update:updateClouds}),form.addHandler("clouds_1",{element:"clouds_1_type",auxiliary:auxiliaryClouds1Type,update:updateClouds}),form.addHandler("clouds_2",{element:"clouds_2",format:formatClouds,auxiliary:auxiliaryClouds2,update:updateClouds}),form.addHandler("clouds_2",{element:"clouds_2_height",auxiliary:auxiliaryClouds2Height,update:updateClouds}),form.addHandler("clouds_2",{element:"clouds_2_coverage",auxiliary:auxiliaryClouds2Coverage,update:updateClouds}),form.addHandler("clouds_2",{element:"clouds_2_type",auxiliary:auxiliaryClouds2Type,update:updateClouds}),form.addHandler("clouds_3",{element:"clouds_3",format:formatClouds,auxiliary:auxiliaryClouds3,update:updateClouds}),form.addHandler("clouds_3",{element:"clouds_3_height",auxiliary:auxiliaryClouds3Height,update:updateClouds}),form.addHandler("clouds_3",{element:"clouds_3_coverage",auxiliary:auxiliaryClouds3Coverage,update:updateClouds}),form.addHandler("clouds_3",{element:"clouds_3_type",auxiliary:auxiliaryClouds3Type,update:updateClouds}),form.addHandler("clouds_4",{element:"clouds_4",format:formatClouds,auxiliary:auxiliaryClouds4,update:updateClouds}),form.addHandler("clouds_4",{element:"clouds_4_height",auxiliary:auxiliaryClouds4Height,update:updateClouds}),form.addHandler("clouds_4",{element:"clouds_4_coverage",auxiliary:auxiliaryClouds4Coverage,update:updateClouds}),form.addHandler("clouds_4",{element:"clouds_4_type",auxiliary:auxiliaryClouds4Type,update:updateClouds}),form.addHandler("temperature",{element:"temperature",format:formatTemperature,auxiliary:auxiliaryTemperature,update:updateTemperature}),form.addHandler("temperature",{element:"dew_point",format:formatTemperature,auxiliary:auxiliaryTemperature,update:updateTemperature}),form.addHandler("temperature",{element:"temperature_range",auxiliary:auxiliaryTemperatureRange,update:updateTemperature}),form.addHandler("temperature",{element:"dew_point_range",auxiliary:auxiliaryTemperatureRange,update:updateTemperature}),form.addHandler("temperature",{element:"temperature_minus",auxiliary:auxiliaryTemperatureMinus,update:updateTemperature}),form.addHandler("temperature",{element:"dew_point_minus",auxiliary:auxiliaryTemperatureMinus,update:updateTemperature}),form.addHandler("pressure",{format:e=>""===(e=e.trim().replace(/\D/,"").substring(0,4))?"":+e>1100?1100:e,auxiliary(e){const{pressure_range:t}=this.elements;t.value=""===e||+e<500?499:e},update:updatePressure}),form.addHandler("pressure",{element:"pressure_range",auxiliary(e){const{pressure:t}=this.elements;t.value=499===+e?"":e},update:updatePressure}),form.addHandler("trend",{element:"trend_text",format:e=>e.trim().toUpperCase(),update:e=>e});